# Sports Decision Analyzer - LSI Incident Analysis Agentnn## OverviewnnA Python agent for analyzing sports incidents and decisions using Databricks data. The agent provides comprehensive analysis of sports events by examining consensus among providers, detecting errors, and answering natural language questions about incidents.nn## Featuresnn- **Data Integration**: Connects to Databricks and queries three key tables (decision_result, raw, extracted)n- **Consensus Analysis**: Verifies real consensus among providersn- **Error Detection**: Identifies extractor errors, missing incidents, and duplicatesn- **Natural Language Interface**: Answers questions about incidents in natural languagen- **Comprehensive Output**: Generates both JSON diagnostics and natural language summariesnn## ArchitecturennThe agent uses **Hexagonal Architecture (Ports & Adapters)** with modular components:nn```n┌─────────────────────────────────────┐n│           Application Core          │n│  (Domain Entities & Business Logic) │n├─────────────────────────────────────┤n│           Ports (Interfaces)        │n│  (Data, Analysis, NLP, Output)      │n├─────────────────────────────────────┤n│           Adapters (Implementation) │n│  (Databricks, Analysis Engine, etc.)│n└─────────────────────────────────────┘n```nn## Quick Startnn### Prerequisitesnn- Python 3.11+n- Databricks workspace accessn- Required environment variables (see Configuration section)nn### Installationnn1. Clone the repository:n```bashngit clone https://github.com/lisandrolan/sports-decision-analyzer.gitncd sports-decision-analyzern```nn2. Install dependencies:n```bashnpip install -r requirements.txtn```nn3. Set up environment variables:n```bashncp .env.example .envn# Edit .env with your Databricks configurationn```nn4. Run the agent:n```bashnpython -m sports_incident_analyzer.mainn```nn## Usagenn### Basic Analysisnn```pythonnfrom sports_incident_analyzer import SportsIncidentAnalyzernn# Initialize the analyzernanalyzer = SportsIncidentAnalyzer()nn# Analyze a specific fixturenresult = await analyzer.analyze_fixture("fixture_123")nn# Get JSON diagnosticndiagnostic = result.get_json_diagnostic()nn# Get natural language summarynsummary = result.get_summary()n```nn### Natural Language Questionsnn```pythonn# Ask specific questions about incidentsnquestion = "¿Por qué a las 03:34:50 no se generó el score 0-9 si el proveedor 8 ya lo había enviado?"nanswer = await analyzer.answer_question(question, "fixture_123")nnprint(answer)n```nn## Configurationnn### Environment VariablesnnCreate a `.env` file with the following variables:nn```envn# Databricks ConfigurationnDATABRICKS_HOST=your-workspace.cloud.databricks.comnDATABRICKS_TOKEN=your-access-tokennDATABRICKS_CATALOG=your-catalognDATABRICKS_SCHEMA=your-schemann# Database TablesnTABLE_DECISION_RESULT=decision_resultnTABLE_RAW=rawnTABLE_EXTRACTED=extractednn# Application ConfigurationnLOG_LEVEL=INFOnCACHE_ENABLED=truenMAX_CONCURRENT_QUERIES=10n```nn## Project Structurenn```nsports_incident_analyzer/n├── core/n│   ├── domain/              # Domain entities and business logicn│   │   ├── entities/        # Core business entitiesn│   │   ├── value_objects/   # Value objectsn│   │   └── services/        # Domain servicesn│   ├── application/         # Application layern│   │   ├── use_cases/       # Use case implementationsn│   │   ├── ports/           # Port interfacesn│   │   └── orchestrators/   # Application orchestratorsn│   └── infrastructure/      # Infrastructure layern│       ├── adapters/        # External service adaptersn│       ├── repositories/    # Data repositoriesn│       └── external_services/ # External service implementationsn├── components/n│   ├── data/               # Data access componentn│   ├── analysis/           # Analysis engine componentn│   ├── nlp/                # Natural language processing componentn│   └── output/             # Output generation componentn├── config/                 # Configuration filesn├── tests/                  # Test suiten├── docs/                   # Documentationn└── examples/               # Usage examplesn```nn## Data Schemann### decision_result Tablen- `fixture_id`: Unique identifier for the fixturen- `incident_type`: Type of incidentn- `decision_type`: Type of decision maden- `score`: Score valuen- `consensus_providers`: Number of providers in consensusn- `participating_providers`: Total participating providersn- `timestamp`: Decision timestampnn### raw Tablen- `fixture_id`: Fixture identifiern- `provider_id`: Provider identifiern- `score`: Score provided by the providern- `status`: Status of the provider messagen- `is_cancelled`: Whether the message was cancelledn- `timestamp`: Message timestampnn### extracted Tablen- `fixture_id`: Fixture identifiern- `incident_type`: Type of incident extractedn- `score`: Extracted scoren- `provider_id`: Provider identifiern- `is_cancelled`: Whether the incident was cancelledn- `timestamp`: Extraction timestampnn## Analysis Featuresnn### Consensus Verificationn- Compares provider scores to verify reported consensusn- Identifies discrepancies between expected and actual consensusn- Analyzes provider agreement patternsnn### Error Detectionn- **Missing Incidents**: Identifies incidents that should have been extracted but weren'tn- **Duplicate Incidents**: Detects duplicate incident extractionsn- **Incorrect Incidents**: Finds incidents that were incorrectly extractedn- **Timing Issues**: Analyzes temporal inconsistenciesnn### Comparison Analysisn- Compares provider submissions with system decisionsn- Identifies score discrepanciesn- Analyzes decision validationn- Detects logical inconsistenciesnn## Natural Language InterfacennThe agent can answer questions like:nn- "¿Por qué a las 03:34:50 no se generó el score 0-9 si el proveedor 8 ya lo había enviado?"n- "¿Qué score envió el proveedor 13 a las 03:30?"n- "¿Por qué no hubo consenso en el incidente del segundo período?"n- "¿Cuántos proveedores participaron en el incidente X?"nn## Output Formatsnn### JSON Diagnosticn```jsonn{n  "fixture_id": "fixture_123",n  "analysis_timestamp": "2024-01-15T10:30:00Z",n  "consensus_analysis": {n    "verified_consensus": true,n    "provider_agreement": 0.85,n    "discrepancies": []n  },n  "error_detection": {n    "missing_incidents": [],n    "duplicate_incidents": [],n    "incorrect_incidents": []n  },n  "comparison_analysis": {n    "provider_vs_system": {n      "matches": 15,n      "discrepancies": 2n    }n  }n}n```nn### Natural Language Summaryn```n"Análisis del fixture fixture_123: Se detectó consenso real entre 8 de 10 proveedores nparticipantes. No se encontraron errores del extractor. El sistema tomó 15 decisiones ncorrectas y 2 con discrepancias menores. El análisis temporal muestra consistencia nen los timestamps de los incidentes."n```nn## TestingnnRun the test suite:nn```bashn# Run all testsnpytestnn# Run with coveragenpytest --cov=sports_incident_analyzernn# Run specific test categoriesnpytest tests/unit/npytest tests/integration/n```nn## Developmentnn### Code Qualitynn```bashn# Format codenblack sports_incident_analyzer/nn# Lint codenflake8 sports_incident_analyzer/nn# Type checkingnmypy sports_incident_analyzer/n```nn### Pre-commit Hooksnn```bashn# Install pre-commit hooksnpre-commit installnn# Run all hooksnpre-commit run --all-filesn```nn## Performance Considerationsnn- **Query Optimization**: Uses optimized SQL queries for Databricksn- **Caching**: Implements caching for frequently accessed datan- **Parallel Processing**: Uses async/await for concurrent operationsn- **Memory Management**: Efficient data processing with pandas/PySparknn## Contributingnn1. Fork the repositoryn2. Create a feature branchn3. Make your changesn4. Add tests for new functionalityn5. Ensure all tests passn6. Submit a pull requestnn## LicensennThis project is licensed under the MIT License - see the LICENSE file for details.nn## SupportnnFor support and questions:n- Create an issue in the repositoryn- Check the documentation in the `docs/` foldern- Review the examples in the `examples/` folder